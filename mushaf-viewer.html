<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mushaf — Verse highlighter</title>
  <!-- Page image is RTL Arabic; coordinates are normalized 0–1 (left=0, right=1) -->
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }
    h1 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0 0 1rem;
      color: #fff;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      width: 100%;
      max-width: 900px;
    }
    .toolbar label { font-size: 0.9rem; }
    .toolbar input[type="number"] {
      width: 5rem;
      padding: 0.4rem 0.5rem;
      font-size: 1rem;
      border: 1px solid #444;
      border-radius: 6px;
      background: #2a2a2a;
      color: #fff;
    }
    .toolbar button {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      border: 1px solid #444;
      border-radius: 6px;
      background: #333;
      color: #fff;
      cursor: pointer;
    }
    .toolbar button:hover { background: #444; }
    .toolbar button.primary { background: #2d5a27; border-color: #3d7a37; }
    .toolbar button.primary:hover { background: #3d7a37; }
    .verse-info {
      font-size: 0.95rem;
      padding: 0.4rem 0.75rem;
      background: #2a2a2a;
      border-radius: 6px;
      border: 1px solid #444;
    }
    .viewer-wrap {
      position: relative;
      max-width: 100%;
      overflow: auto;
      border-radius: 8px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.4);
      background: #111;
      display: inline-block;
    }
    .viewer-wrap img {
      display: block;
      max-width: 100%;
      height: auto;
      vertical-align: top;
    }
    .overlay {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .overlay .highlight {
      position: absolute;
      pointer-events: none;
      background: rgba(255, 212, 0, 0.35);
      border: 2px solid rgba(255, 212, 0, 0.8);
      border-radius: 3px;
      transition: background 0.15s, border-color 0.15s;
    }
    .overlay .highlight.active {
      background: rgba(255, 212, 0, 0.5);
      border-color: rgba(255, 212, 0, 1);
      box-shadow: 0 0 0 1px rgba(255, 212, 0, 0.3);
    }
    .highlight-layer {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .hit-layer {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: auto;
      cursor: pointer;
    }
    .hit-layer [data-verse] {
      position: absolute;
      cursor: pointer;
    }
    .hit-layer [data-verse]:hover { background: rgba(255,255,255,0.05); }
    .load-msg {
      text-align: center;
      padding: 2rem;
      max-width: 400px;
      margin: 1rem auto;
      background: #2a2a2a;
      border: 1px dashed #555;
      border-radius: 8px;
      color: #999;
    }
    .load-msg p { margin: 0 0 0.75rem; }
    .load-msg input[type="file"] { margin-top: 0.5rem; }
    .load-msg a { color: #6ab; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <h1>Mushaf — click a verse to highlight</h1>

  <div id="loadMsg" class="load-msg">
    <p><strong>Load verse data</strong></p>
    <p>Open this page from a local server so the CSV and images load, or choose <code>data_verse.csv</code> below.</p>
    <p><small>From repo folder: <code>python3 -m http.server 8000</code> then open <a href="http://localhost:8000/mushaf-viewer.html">http://localhost:8000/mushaf-viewer.html</a></small></p>
    <p>Or load file manually:</p>
    <input type="file" id="csvFile" accept=".csv" />
  </div>

  <div id="app" class="hidden">
    <div class="toolbar">
      <label>Page</label>
      <input type="number" id="pageNum" min="1" max="604" value="1" />
      <button type="button" id="prevBtn">Previous</button>
      <button type="button" id="nextBtn">Next</button>
      <span class="verse-info" id="verseInfo">Click a verse on the page</span>
    </div>

    <div class="viewer-wrap" id="viewerWrap">
      <img id="pageImg" src="" alt="Mushaf page" />
      <div class="overlay" id="overlay">
        <div class="highlight-layer" id="highlightLayer"></div>
        <div class="hit-layer" id="hitLayer"></div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const PAGE_MIN = 1;
      const PAGE_MAX = 604;
      let verseData = []; // { page, surah_number, verse_number, x_start, y_start, x_end, y_end }
      let currentPage = 1;
      let activeVerseKey = null;

      const loadMsg = document.getElementById('loadMsg');
      const app = document.getElementById('app');
      const csvFileInput = document.getElementById('csvFile');
      const pageNumInput = document.getElementById('pageNum');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const verseInfo = document.getElementById('verseInfo');
      const pageImg = document.getElementById('pageImg');
      const viewerWrap = document.getElementById('viewerWrap');
      const overlay = document.getElementById('overlay');
      const highlightLayer = document.getElementById('highlightLayer');
      const hitLayer = document.getElementById('hitLayer');

      function parseCSV(text) {
        const lines = text.trim().split('\n');
        if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => h.trim());
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
          const vals = lines[i].split(',');
          const row = {};
          headers.forEach((h, j) => { row[h] = vals[j] != null ? vals[j].trim() : ''; });
          const r = {
            page: parseInt(row.page, 10),
            surah_number: parseInt(row.surah_number, 10),
            verse_number: parseInt(row.verse_number, 10),
            x_start: parseFloat(row.x_start),
            y_start: parseFloat(row.y_start),
            x_end: parseFloat(row.x_end),
            y_end: parseFloat(row.y_end)
          };
          if (row.segment !== undefined && row.segment !== '') r.segment = parseInt(row.segment, 10);
          rows.push(r);
        }
        return rows;
      }

      function initWithData(data) {
        verseData = data;
        loadMsg.classList.add('hidden');
        app.classList.remove('hidden');
        pageNumInput.value = currentPage;
        loadPage(currentPage);
      }

      function loadCSVFile(file) {
        const reader = new FileReader();
        reader.onload = function () {
          const data = parseCSV(reader.result);
          if (data.length) initWithData(data);
          else alert('Could not parse CSV.');
        };
        reader.readAsText(file);
      }

      csvFileInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file) loadCSVFile(file);
      });

      function getVersesForPage(page) {
        return verseData.filter(v => v.page === page);
      }

      function verseKey(v) {
        return v.page + '-' + v.surah_number + '-' + v.verse_number;
      }

      function loadPage(page) {
        page = Math.max(PAGE_MIN, Math.min(PAGE_MAX, page));
        currentPage = page;
        pageNumInput.value = page;

        pageImg.src = page + '.jpg';
        pageImg.alt = 'Page ' + page;

        // All segments for this page (multiple rows per verse for multi-line verses)
        const segments = getVersesForPage(page);
        hitLayer.innerHTML = '';
        highlightLayer.innerHTML = '';

        segments.forEach(function (v) {
          const key = verseKey(v);
          const w = Math.max(0, (v.x_end - v.x_start) * 100);
          const h = Math.max(0, (v.y_end - v.y_start) * 100);

          const hitDiv = document.createElement('div');
          hitDiv.setAttribute('data-verse', key);
          hitDiv.setAttribute('data-surah', v.surah_number);
          hitDiv.setAttribute('data-verse-num', v.verse_number);
          hitDiv.style.left = (v.x_start * 100) + '%';
          hitDiv.style.top = (v.y_start * 100) + '%';
          hitDiv.style.width = w + '%';
          hitDiv.style.height = h + '%';
          hitDiv.addEventListener('click', function (e) {
            e.stopPropagation();
            highlightVerse(v);
          });
          hitLayer.appendChild(hitDiv);

          const hl = document.createElement('div');
          hl.className = 'highlight';
          hl.setAttribute('data-verse', key);
          hl.style.left = (v.x_start * 100) + '%';
          hl.style.top = (v.y_start * 100) + '%';
          hl.style.width = w + '%';
          hl.style.height = h + '%';
          highlightLayer.appendChild(hl);
        });

        activeVerseKey = null;
        verseInfo.textContent = 'Click a verse on the page';
        highlightLayer.querySelectorAll('.highlight').forEach(el => el.classList.remove('active'));
      }

      function highlightVerse(v) {
        const key = verseKey(v);
        if (activeVerseKey === key) return;
        activeVerseKey = key;
        verseInfo.textContent = 'Sūrah ' + v.surah_number + ', Āyah ' + v.verse_number;
        // Activate all segments of this verse (multi-line: every rect with this key)
        highlightLayer.querySelectorAll('.highlight[data-verse="' + key + '"]').forEach(el => {
          el.classList.add('active');
        });
        highlightLayer.querySelectorAll('.highlight:not([data-verse="' + key + '"])').forEach(el => {
          el.classList.remove('active');
        });
      }

      function goPrev() {
        if (verseData.length && currentPage > PAGE_MIN) loadPage(currentPage - 1);
      }

      function goNext() {
        if (verseData.length && currentPage < PAGE_MAX) loadPage(currentPage + 1);
      }

      prevBtn.addEventListener('click', goPrev);
      nextBtn.addEventListener('click', goNext);
      pageNumInput.addEventListener('change', function () {
        const n = parseInt(this.value, 10);
        if (!isNaN(n)) loadPage(n);
      });

      function sizeOverlayToImage() {
        var w = pageImg.offsetWidth;
        var h = pageImg.offsetHeight;
        overlay.style.width = w + 'px';
        overlay.style.height = h + 'px';
      }

      pageImg.addEventListener('load', sizeOverlayToImage);
      window.addEventListener('resize', function () {
        if (pageImg.offsetWidth) sizeOverlayToImage();
      });

      // Try to load CSV from same origin (works when served)
      fetch('data_verse.csv')
        .then(r => r.ok ? r.text() : Promise.reject())
        .then(parseCSV)
        .then(function (data) {
          if (data.length) initWithData(data);
        })
        .catch(function () {
          // Keep load message visible for file picker or server instructions
        });
    })();
  </script>
</body>
</html>
